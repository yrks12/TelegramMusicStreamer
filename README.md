# Telegram YouTube Music Bot

A personal Telegram bot that lets you search, play, queue, and review history of YouTube audio tracks. The bot manages a session-based queue with inline controls, auto-advances tracks, shows thumbnails and authors, maintains history, and can serve a live radio stream via HLS. Designed for single-user personal use.

---

## Project Overview

This bot acts as your personal YouTube music client, allowing you to search for tracks, play individual videos or entire playlists, manage a playback queue, and track your listening history. All operations are performed through simple Telegram commands and inline controls, making it easy to discover and enjoy music on the go.

---

## Setup & Installation

### Prerequisites

- Python 3.8 or higher
- ffmpeg installed on your system
- A Telegram bot token from [@BotFather](https://t.me/botfather)

### Installation Steps

1. **Clone or open the project**
   - Fork this project or create a new Replit Python project
   - Upload all the project files to your environment

2. **Install dependencies**
   ```bash
   pip install -r requirements.txt
   ```

3. **Install ffmpeg**
   - On Replit: Use the Packages tab to install "ffmpeg"
   - Or run: `apt-get update && apt-get install -y ffmpeg`
   - Verify: `ffmpeg -version`

4. **Configure environment variables**
   - Create a `.env` file in the root directory with:
     ```
     TELEGRAM_TOKEN=your_bot_token_here
     ```
   - Or use Replit Secrets to set `TELEGRAM_TOKEN`

5. **Run the bot**
   ```bash
   python main.py
   ```

---

## File Structure

- **main.py**: All command and callback handlers, session class, radio process logic, and bot entrypoint.
- **utils/ytdl_wrapper.py**: YouTube search, playlist extraction, and audio download (returns metadata).
- **utils/playlist_manager.py**: JSON-backed queue management for user playlists.
- **utils/storage.py**: JSON-backed listening history storage and retrieval.
- **data/history.json**: Stores per-user play history (created automatically).
- **data/playlists.json**: Stores per-user queues (created automatically).
- **downloads/**: Temporary folder for audio and thumbnail files, organized by user ID.
- **public/**: (If present) HLS stream files generated by `/radio`.
- **requirements.txt**: Pinned dependencies for the project.
- **README.md**: This documentation file.

---

## Features and Flows

### Search Flow

- `/search <keywords>`:  
  - Runs `search_youtube()` in `utils/ytdl_wrapper.py`.
  - Replies with up to 5 inline buttons, each showing ‚ÄúTitle (MM:SS) ‚Äì by Author.‚Äù
  - Tapping a result deletes the search UI and user query, then starts or enqueues the track.

### Play Flow

- `/play <YouTube URL or ID>`:  
  - Detects playlist vs. single video.
  - For playlists: enqueues all tracks and starts playback if not already playing.
  - For single videos: plays immediately.
  - Deletes the user‚Äôs command message after enqueuing/playing.

### Now Playing

- Shows a ‚Äú‚è¨ Downloading‚Ä¶‚Äù status, then a ‚Äúüé∂ Now Playing‚Äù message with:
  - Track thumbnail
  - Title
  - Author/uploader
  - Duration
  - Inline controls (‚èÆÔ∏è Prev, ‚è∏Ô∏è Pause/‚ñ∂Ô∏è Resume, ‚è≠Ô∏è Next, ‚èπÔ∏è Stop)
- Sends the audio file with the same thumbnail and caption.

### Auto-Advance

- After each audio upload completes, the bot automatically calls `start_next()` to send the next track, looping until the queue is empty.

### Queue and Control Flow

- Inline controls (‚èÆÔ∏è, ‚è∏Ô∏è/‚ñ∂Ô∏è, ‚è≠Ô∏è, ‚èπÔ∏è) modify `session.current_index`, pause/resume downloads, or stop the session.
- `/next` or `/queue` manually skips to the next track (identical to tapping ‚è≠Ô∏è).

### History

- `/history`: Displays your last 10 plays as  
  `‚ñ∂Ô∏è [HH:MM YYYY-MM-DD] Title (MM:SS) ‚Äì by Author`.

### Radio Mode

- `/radio <query or URL>`: Starts a live HLS radio stream (if implemented), replies with a public HTTP link to `.m3u8` or `.mp3`.
- `/stopradio`: Kills the background radio process and replies ‚Äúüõë Radio stopped.‚Äù

---

## Usage & Commands

| Command / Control | Description |
|-------------------|-------------|
| `/start` | Sends a welcome message with all available commands and inline controls. |
| `/search <keywords>` | Search YouTube, show top-5 results as inline buttons. |
| *Tap search result* | Deletes search UI, starts or enqueues track, shows ‚Äú‚è¨ Downloading‚Ä¶‚Äù, then ‚Äúüé∂ Now Playing‚Äù with controls. |
| `/play <URL or ID>` | Enqueue single or playlist URL; starts playback if not already playing. |
| ‚èÆÔ∏è | Go to previous track. |
| ‚è∏Ô∏è/‚ñ∂Ô∏è | Pause/resume current track. |
| ‚è≠Ô∏è | Skip to next track (auto-advance also triggers). |
| ‚èπÔ∏è | Stop and delete session. |
| `/next` or `/queue` | Manual skip to next (identical to ‚è≠Ô∏è). |
| `/history` | Display last 10 plays as ‚Äú‚ñ∂Ô∏è [HH:MM YYYY-MM-DD] Title (MM:SS) ‚Äì by Author.‚Äù |
| `/radio <artist/mix/playlist or URL>` | Start a live HLS radio stream (if implemented). |
| `/stopradio` | Terminate the live stream process. |

---

## Session Details

### `Session` Class (main.py)

- **Fields:**
  - `queue`: List of track dicts (title, url, duration, uploader, thumbnail)
  - `current_index`: Index of the currently playing track
  - `message_id`: Telegram message ID of the ‚ÄúNow Playing‚Äù message
  - `downloading_message_id`: Telegram message ID of the ‚ÄúDownloading‚Ä¶‚Äù message
  - `is_paused`: Whether playback is paused
  - `current_download_task`: (If used) Reference to the current download task
  - `chat_id`: Telegram chat ID for the session

- **Methods:**
  - `add_track(track_info)`: Add a track to the queue
  - `get_current_track()`: Get the current track info
  - `next_track()`, `prev_track()`: Move to next/previous track
  - `clear()`: Clear the session state

- **Cleanup:**  
  - Temporary audio and thumbnail files are deleted after sending.
  - Old downloads can be cleaned up on startup (see `cleanup_old_downloads()`).

---

## Technical Details

- **Audio Quality:** All downloads are converted to M4A at 192kbps for optimal quality/size balance.
- **Thumbnails:** Track thumbnails are downloaded, resized to 320x180, and attached to both the ‚ÄúNow Playing‚Äù and audio messages.
- **Storage:** User queues and history are stored in JSON files (`data/`), with automatic cleanup of temporary files.
- **Concurrency:** All YouTube operations use async/await patterns to prevent blocking the bot.
- **Error Handling:** Comprehensive error handling with user-friendly messages and fallbacks if thumbnail processing fails. Inline controls remain available during errors.

---

## Utility Modules

### `utils/ytdl_wrapper.py`

- **`search_youtube(query, max_results)`**:  
  Uses yt-dlp to search YouTube, returns a list of dicts (`id`, `title`, `duration`, `webpage_url`, `thumbnail`, `uploader`).

- **`extract_playlist_videos(playlist_url)`**:  
  Returns a list of dicts for every video in the playlist.

- **`download_audio_stream(url, user_id)`**:  
  Downloads audio as M4A, returns a dict with `filepath`, `uploader`, `thumbnail`.  
  Uses parallel fragment downloads, retries, and yt-dlp postprocessing.

- **`get_video_info(url)`**:  
  Returns metadata for a video without downloading.

### `utils/playlist_manager.py`

- **`PlaylistManager` class**:  
  - `enqueue(user_id, track_info)`: Add track to user‚Äôs queue
  - `dequeue(user_id)`: Remove and return first track
  - `peek(user_id)`: Return first track without removing
  - `clear(user_id)`: Clear user‚Äôs queue
  - `list_queue(user_id)`: Get current queue
  - JSON persistence in `data/playlists.json`

### `utils/storage.py`

- **`StorageManager` class**:  
  - `record_play(user_id, track_info)`: Add a play to history (with timestamp, title, url, duration)
  - `get_history(user_id, limit)`: Return last N entries
  - Keeps only the last 100 entries per user
  - JSON persistence in `data/history.json`

---

## Error Handling

- Handles missing downloads, session expiration, invalid URLs, oversized files, and thumbnail download failures.
- All `delete_message` calls are wrapped in try/except to avoid errors if messages are already gone.
- Inline controls remain available during errors.

---

## Dependencies & Environment

- Python 3.8+
- `python-telegram-bot==22.1`
- `yt-dlp==2025.5.22`
- `python-dotenv>=0.21.0`
- `Pillow>=10.0.0`
- `requests>=2.31.0`
- System-level `ffmpeg` required

---

## Future Improvements

- Add unit tests for utility modules
- Consider caching MP3s to avoid redownloading the same track
- Implement cleanup of old files on startup
- Add queue management commands (view queue, clear queue, remove specific tracks)
- Support for audio quality selection
- Integration with music streaming APIs for enhanced metadata
- Optional voice-chat streaming via a user-bot

---

## Troubleshooting

1. **"ffmpeg not found"**: Ensure ffmpeg is installed and accessible in your PATH.
2. **"No such file or directory"**: Check that all project files are uploaded correctly.
3. **Bot not responding**: Verify your `TELEGRAM_TOKEN` is set correctly.
4. **Download failures**: Some videos may be restricted‚Äîtry different content.
5. **Missing thumbnails**: If thumbnail processing fails, the bot will fall back to text-only messages.

For any issues, check the console output for detailed error messages.

---

**Enjoy your personal Telegram YouTube Music Bot!**